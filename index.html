<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clean Affiliate Link</title>
</head>
<body>
    <h1>=== Loại bỏ mã Affiliate từ link rút gọn hoặc link trực tiếp ===</h1>
    <form id="linkForm">
        <label for="linkInput">Nhập link cần làm sạch:</label>
        <input type="text" id="linkInput" placeholder="Nhập link tại đây" required>
        <button type="submit">Làm sạch</button>
    </form>
    <pre id="result"></pre>

    <script>
        // Hàm mở rộng link rút gọn thông qua API Vercel
        async function expandShortLink(shortLink) {
            try {
                const apiUrl = `https://expand-link-o4ptlwx3u-bigmans-projects-a2db2462.vercel.app/api/expand?url=${encodeURIComponent(shortLink)}`;
                const response = await fetch(apiUrl);

                if (!response.ok) {
                    console.error('API Vercel không phản hồi đúng:', response.statusText);
                    return shortLink;
                }

                const data = await response.json();
                console.log('Kết quả từ API:', data);

                if (data.resolved_url) {
                    console.log('Link mở rộng:', data.resolved_url);
                    return data.resolved_url; // Sử dụng kết quả API
                } else {
                    console.error('API không trả về resolved_url.');
                    return shortLink;
                }
            } catch (error) {
                console.error('Lỗi mở rộng link:', error.message);
                return shortLink;
            }
        }

        // Hàm làm sạch link
        function cleanAffiliateLink(link) {
            try {
                const parsedUrl = new URL(link);
                const affiliateParams = [
                    'uls_trackid', 'utm_campaign', 'utm_content', 'utm_medium', 'utm_source',
                    'utm_term', 'trafficFrom', 'laz_trackid', 'mkttid', 'dsource',
                    'laz_share_info', 'laz_token', 'exlaz', 'smtt',
                ];

                affiliateParams.forEach(param => parsedUrl.searchParams.delete(param));
                return parsedUrl.origin + parsedUrl.pathname + (parsedUrl.search ? parsedUrl.search : '');
            } catch (error) {
                console.error('Link không hợp lệ:', error.message);
                return null;
            }
        }

        // Xử lý sự kiện nhấn nút "Làm sạch"
        document.getElementById('linkForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const inputLink = document.getElementById('linkInput').value;
            const result = document.getElementById('result');

            result.textContent = `=== Loại bỏ mã Affiliate từ link rút gọn hoặc link trực tiếp ===\n`;
            result.textContent += `Nhập link cần làm sạch: ${inputLink}\n`;
            result.textContent += `Đang kiểm tra và mở rộng link rút gọn nếu cần...\n`;

            try {
                const expandedLink = await expandShortLink(inputLink);
                result.textContent += `Link gốc: ${expandedLink}\n`;

                const cleanedLink = cleanAffiliateLink(expandedLink);
                result.textContent += `Đang làm sạch link...\n`;
                result.textContent += cleanedLink
                    ? `Link đã làm sạch: ${cleanedLink}`
                    : `Lỗi: Không thể làm sạch link.`;
            } catch (error) {
                result.textContent += `Lỗi xử lý: ${error.message}`;
            }
        });
    </script>
</body>
</html>
